name: Celestia

on:
  push:
    branches: [ master ]
    paths: [ src/**, .github/workflows/*.yml ]
  pull_request:
    branches: [ master ]
    paths: [ src/**, .github/workflows/*.yml ]

env:
  BUILD_TYPE: RelWithDebInfo
  CTEST_OUTPUT_ON_FAILURE: 1
  VCPKG_BINARY_SOURCES: 'clear;nuget,GitHub,readwrite'

jobs:
  sonarscanner:
    runs-on: amd64
    steps:
    - name: 'Install dependencies'
      run: |
        sudo apt update
        sudo apt install -y libeigen3-dev \
                            libepoxy-dev \
                            libavcodec-dev \
                            libavformat-dev \
                            libavutil-dev \
                            libswscale-dev \
                            libjpeg-dev \
                            libpng-dev \
                            libglu1-mesa-dev \
                            qtbase5-dev \
                            qtbase5-dev-tools \
                            libqt5opengl5-dev \
                            libgtk-3-dev \
                            libfreetype6-dev \
                            libsdl2-dev \
                            libluajit-5.1-dev \
                            libfmt-dev \
                            ninja-build
    - name: 'Checkout source code'
      uses: actions/checkout@v2
      with:
        submodules: true
        # Disabling shallow clone is recommended for improving relevancy of reporting
        fetch-depth: 0

    - name: 'Configure CMake'
      run: |
        cmake -B ${{github.workspace}}/build \
              -G Ninja                       \
              -DENABLE_GLES=ON               \
              -DENABLE_SPICE=OFF             \
              -DENABLE_TOOLS=OFF             \
              -DENABLE_TESTS=ON              \
              -DENABLE_SDL=ON                \
              -DENABLE_GTK=ON                \
              -DUSE_GTK3=ON                  \
              -DENABLE_QT=ON                 \
              -DENABLE_FFMPEG=OFF            \
              -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

    - name: Analyze
      run: |
        sonar-scanner                                                   \
          -Dsonar.cfamily.compile-commands=build/compile_commands.json  \
          -Dsonar.organization=celestiaproject                          \
          -Dsonar.projectKey=CelestiaProject_Celestia                   \
          -Dsonar.sources=src/                                          \
          -Dsonar.test.exclusions=test/**                               \
          -Dsonar.tests=test/
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
